{% extends 'base.html' %}
{% load static %}
{% load json_script %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/analizadorEEG/inicio.css' %}">
{% endblock %}

{% block content %}
<div class="content">
    <div class="">
        <div class="page-header-title">
            <h4 class="page-title">Elegir resultado</h4>
        </div>
    </div>

    <br>

    <div class="page-content-wrapper">
        <div class="container">
            <div class="panel panel-default">
                <div class="panel-body">
                    {% if lista_archivos|length > 0 %}
                    <table class="table table-hover">
                        <thead>
                        <tr style="color:#0E2EB0">
                            <th>Id</th>
                            <th>Nombre</th>
                            <th>Fecha</th>
                            <th>Ver Resultado</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for archivo in lista_archivos %}
                        {% with resultado=archivo.resultado_analisis|json_script:"resultado_json" %}
                        <tr>
                            <td>{{ archivo.id }}</td>
                            <td>{{ archivo.nombre }}</td>
                            <td>{{ archivo.fecha }}</td>
                            <td>
                                <div>
                                    <!-- Mostrar solo el campo 'diagnostico' -->
                                    <strong>Diagnóstico:</strong>
                                    <span id="diagnostico-{{ archivo.id }}"></span>

                                    <!-- Botón para mostrar detalles -->
                                    <br>
                                    <button class="btn btn-link" onclick="toggleDetalles({{ archivo.id }})">
                                        Ver detalles
                                    </button>

                                    <!-- Contenedor oculto de detalles -->
                                    <div id="detalles-{{ archivo.id }}" style="display: none; margin-top: 10px;">
                                        <ul id="detalle-lista-{{ archivo.id }}"></ul>
                                    </div>

                                    <!-- Script con el JSON -->
                                    <script type="application/json" id="resultado_json_{{ archivo.id }}">
                                        {{ archivo.resultado_analisis|safe }}
                                    </script>
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div style="text-align: center; font-weight: bold; color: #0E2EB0; margin-top: 20px;">
                        No hay resultados de EEG disponibles.
                    </div>
                    {% endif %}

                    <div style="text-align:center;">
                        <button type="button" class="btn btn-primary waves-effect waves-light"
                                onClick=" window.location.href='/eventos/EEG' ">
                            Back
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para mostrar diagnostico y detalles -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        {% for archivo in lista_archivos %}
        const resultado = JSON.parse(document.getElementById("resultado_json_{{ archivo.id }}").textContent);
        document.getElementById("diagnostico-{{ archivo.id }}").textContent = resultado.diagnostico;

        const lista = document.getElementById("detalle-lista-{{ archivo.id }}");
        for (const [clave, valor] of Object.entries(resultado)) {
            if (clave !== "diagnostico") {
                const item = document.createElement("li");
                item.innerHTML = `<strong>${clave}:</strong> ${JSON.stringify(valor, null, 2)}`;
                lista.appendChild(item);
            }
        }
        {% endfor %}
    });

    function toggleDetalles(id) {
        const div = document.getElementById("detalles-" + id);
        div.style.display = div.style.display === "none" ? "block" : "none";
    }
</script>
{% endblock %}
